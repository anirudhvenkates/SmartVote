<!DOCTYPE html>
<html>
  <head>
    <title>Voter Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
    <script src="vote_abi.js"></script>
  </head>
  <body>
    <h1>Voter Dashboard</h1>

    <!-- Section to dynamically display available proposals -->
    <div>
      <h3>Vote for a Proposal</h3>
      <div id="proposalButtons">
        <!-- Dynamic proposal buttons will be appended here -->
      </div>
    </div>

    <!-- Section to delegate vote -->
    <div>
      <h3>Delegate Your Vote</h3>
      <input type="text" id="delegateTo" placeholder="Enter address to delegate to" /><br><br>
      <button onclick="delegateVote()">Delegate Vote</button>
    </div>

    <!-- Section to view remaining time -->
    <div>
      <h3>Voting Time Remaining</h3>
      <p id="remainingTime">Click to load remaining time...</p>
      <button onclick="updateRemainingTime()">Check Remaining Time</button>
    </div>

    <script>
      const web3 = new Web3(Web3.givenProvider || "http://localhost:7545");
      const VotecontractAddress = "0x1b4B5C2883e264213E7607A72521b1178A7F0365"; // Replace with your deployed contract address
      const voteContract = new web3.eth.Contract(voteABI, VotecontractAddress);
	  
	  async function loadProposals() {
		try {
			// Get the number of proposals
			const proposalsCount = await voteContract.methods.proposalsLength().call();

			// Clear any existing buttons
			const proposalButtonsDiv = document.getElementById("proposalButtons");
			proposalButtonsDiv.innerHTML = '';

			// Check if there are proposals
			if (proposalsCount === 0) {
				alert("No proposals available.");
				return;
			}

			// Loop through each proposal and create a button for it
			for (let i = 0; i < proposalsCount; i++) {
			const proposal = await voteContract.methods.getProposal(i).call();
			console.log("Proposal data:", proposal);  // Log proposal data to the console

			// Get the proposal name and remove padding
			let proposalName = web3.utils.hexToUtf8(proposal[0]);

			// Clean up padding (remove trailing zeros) if necessary
			proposalName = proposalName.replace(/\0+$/, '');

			// Check if the proposal name is valid
			if (!proposalName || proposalName === "0x") {
				console.error("Invalid proposal name at index " + i);
				continue; // Skip invalid proposals
			}

			// Create a button for this proposal
			const button = document.createElement('button');
			button.innerText = `Vote for ${proposalName}`;
			button.onclick = () => vote(i); // Pass the proposal index to the vote function
			proposalButtonsDiv.appendChild(button);
			proposalButtonsDiv.appendChild(document.createElement('br')); // Line break for better layout
			}
	} catch (error) {
		console.error("Error loading proposals: ", error);
		alert("There was an error fetching the proposals.");
	}
	}

      async function vote(proposalIndex) {
        try {
          const accounts = await web3.eth.requestAccounts();
          const account = accounts[0];

          await voteContract.methods.vote(proposalIndex).send({ from: account });
          alert("Vote has been cast!");
        } catch (error) {
          console.error("Error casting vote: ", error);
          alert("There was an error while casting your vote.");
        }
      }

      async function delegateVote() {
        try {
          const accounts = await web3.eth.requestAccounts();
          const account = accounts[0];
          const delegateToAddress = document.getElementById("delegateTo").value;

          if (!web3.utils.isAddress(delegateToAddress)) {
            alert("Please enter a valid Ethereum address.");
            return;
          }

          await voteContract.methods.delegate(delegateToAddress).send({ from: account });
          alert("Vote delegated to: " + delegateToAddress);
        } catch (error) {
          console.error("Error delegating vote: ", error);
          alert("There was an error while delegating the vote.");
        }
      }

      async function updateRemainingTime() {
        try {
          const remainingTimeInSeconds = await voteContract.methods.remainingTime().call();
          
          const hours = Math.floor(remainingTimeInSeconds / 3600);
          const minutes = Math.floor((remainingTimeInSeconds % 3600) / 60);
          const seconds = remainingTimeInSeconds % 60;

          const timeString = `${hours} hours, ${minutes} minutes, ${seconds} seconds`;
          document.getElementById("remainingTime").innerText = "Time remaining: " + timeString;
        } catch (error) {
          console.error("Error fetching remaining time: ", error);
          alert("There was an error fetching the remaining time.");
        }
      }

      // Load proposals when the page is loaded
      window.onload = loadProposals;
    </script>
  </body>
</html>
