<html>
  <head>
    <title>SmartVote Voting</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
    <script src="ballot_abi.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      h1 {
        color: #4CAF50;
      }
      button {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        margin: 10px;
      }
      button:hover {
        background-color: #45a049;
      }
      input[type="text"] {
        padding: 10px;
        width: 250px;
        margin: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
      #remainingTime {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Enter Ballot ID</h1>
    <div>
      <input type="text" id="ballotIdInput" placeholder="Enter ballot ID" /><br><br>
      <button onclick="getBallotAddress()">Load Ballot</button>
    </div>
	
    <h1>Vote for your favorite proposal!</h1>
    <div>
      <button onclick="vote(0)">Vote for Proposal 1</button>
      <button onclick="vote(1)">Vote for Proposal 2</button>
      <button onclick="vote(2)">Vote for Proposal 3</button>
    </div>

    <h1>Delegate Your Vote</h1>
    <div>
        <h3>Delegate Vote</h3>
        <input type="text" id="delegateTo" placeholder="Enter address to delegate to" /><br><br>
        <button onclick="delegateVote()">Delegate Vote</button>
    </div>

    <h1>Voting Time Remaining</h1>
    <div>
      <p id="remainingTime">Click to load remaining time...</p>
      <button onclick="updateRemainingTime()">Check Remaining Time</button>
    </div>
    
    <script>
      const web3 = new Web3(Web3.givenProvider || "http://localhost:7545"); // Connect to Ganache

      const ballotManagerAddress = "0x5D3b423B54FD1fACf734440e9B6834910336834B"; // Replace with your BallotManager contract address
      const ballotManagerContract = new web3.eth.Contract(ballotManagerABI, ballotManagerAddress);

      let ballotContract; // This will hold the active Ballot contract instance

      // Function to fetch the address of the active ballot from BallotManager
      async function getBallotAddress() {
		const ballotIdInput = document.getElementById("ballotIdInput").value;
		if (!ballotIdInput) {
			alert("Please enter a valid ballot ID.");
			return;
		}
		
        try {
          const ballotAddress = await ballotManagerContract.methods.getBallotAddress(ballotIdInput).call();
          if (ballotAddress === "0x0000000000000000000000000000000000000000") {
            alert("No active ballot found for the provided ID.");
            return null;
          }
          ballotContract = new web3.eth.Contract(ballotABI, ballotAddress);
		  alert(`Ballot contract set to: ${ballotAddress}`);
          console.log("Ballot contract set to:", ballotAddress);
        } catch (error) {
          console.error("Error fetching ballot address:", error);
          alert("There was an error fetching the ballot address.");
        }
      }

      // Function to check the remaining time for voting
      async function updateRemainingTime() {
        if (!ballotContract) {
          alert("Please load a ballot first.");
          return;
        }
        try {
          const remainingTimeInSeconds = await ballotContract.methods.remainingTime().call();

          // Calculate hours, minutes, and seconds
          const hours = Math.floor(remainingTimeInSeconds / 3600);
          const minutes = Math.floor((remainingTimeInSeconds % 3600) / 60);
          const seconds = remainingTimeInSeconds % 60;

          // Display the remaining time in the format: "X hours, Y minutes, Z seconds"
          const timeString = `${hours} hours, ${minutes} minutes, ${seconds} seconds`;

          document.getElementById("remainingTime").innerText = "Time remaining: " + timeString;
        } catch (error) {
          console.error("Error fetching remaining time: ", error);
          alert("There was an error fetching the remaining time.");
        }
      }

      // Function to cast a vote for a proposal
      async function vote(proposalIndex) {
        if (!ballotContract) {
          alert("Please load a ballot first.");
          return;
        }
        try {
          const accounts = await web3.eth.requestAccounts();
          const account = accounts[0];
          await ballotContract.methods.vote(proposalIndex).send({ from: account });
          alert("Vote has been cast!");
        } catch (error) {
          console.error("Error casting vote: ", error);
          alert("There was an error while casting your vote.");
        }
      }

      // Function to delegate a vote to another address
      async function delegateVote() {
        if (!ballotContract) {
          alert("Please load a ballot first.");
          return;
        }
        try {
          const accounts = await web3.eth.requestAccounts();
          const account = accounts[0];
          const delegateToAddress = document.getElementById("delegateTo").value;

          if (!web3.utils.isAddress(delegateToAddress)) {
            alert("Please enter a valid Ethereum address.");
            return;
          }

          await ballotContract.methods.delegate(delegateToAddress).send({ from: account });
          alert("Vote delegated to: " + delegateToAddress);
        } catch (error) {
          console.error("Error delegating vote: ", error);
          alert("There was an error while delegating the vote.");
        }
      }
    </script>
  </body>
</html>