<html>
  <head>
    <title>Voting DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
	<script src="ballot_abi.js"></script>
  </head>
  <body>
	<h1>Ballot Voting</h1>
	<div>
        <h3>Grant Voting Rights</h3>
        <!--textarea id="votersList" placeholder="Enter addresses separated by commas"></textarea><br><br-->
        <button onclick="grantVotingRights()">Grant Voting Rights</button>
    </div>
	
    <h1>Vote for your favorite proposal!</h1>
    <div>
      <button onclick="vote(0)">Vote for Proposal 1</button>
      <button onclick="vote(1)">Vote for Proposal 2</button>
      <button onclick="vote(2)">Vote for Proposal 3</button>
    </div>
	
	<h1>Delegate Your Vote</h1>
    <div>
        <h3>Delegate Vote</h3>
        <input type="text" id="delegateTo" placeholder="Enter address to delegate to" /><br><br>
        <button onclick="delegateVote()">Delegate Vote</button>
    </div>
	
	<h1>Declare Winner</h1>
	<div>
        <h3>Grant Voting Rights</h3>
        <!--textarea id="votersList" placeholder="Enter addresses separated by commas"></textarea><br><br-->
        <button onclick="getWinnerName()">Get Winner Name</button>
    </div>
	
	<h1>Voting Time Remaining</h1>
    <div>
      <p id="remainingTime">Click to load remaining time...</p>
      <button onclick="updateRemainingTime()">Check Remaining Time</button>
    </div>

    <script>
      const web3 = new Web3(Web3.givenProvider || "http://localhost:7545"); // Connect to Ganache

      const contractAddress = "0xC5Ed0b582c812c81A915044782E50470C2AEf2b2"; // Replace with your deployed contract address
      //const abi = [...]  // ABI generated by Truffle or Remix
	  
	  //const ballotContract = new web3.eth.Contract(abi, contractAddress);
	  const ballotContract = new web3.eth.Contract(ballotABI, contractAddress);
	  
	  // Function to grant voting rights (called by chairperson)
      async function grantVotingRights() {
      try {
      const accounts = await web3.eth.requestAccounts();
      const chairpersonAddress = accounts[0];  // Chairperson is the connected account
	  
      // Example of voter addresses. You could input these dynamically.
      const voterAddresses = ["0x0c55269872b31BBbf704DBa5D143C2C671a436AF", "0xcCe19b51b0A9CBF2754083dAAC018a67aF2cd098"];  // Replace with actual addresses

      await ballotContract.methods.giveRightsToMultipleVoters(voterAddresses).send({ from: chairpersonAddress });
      alert("Voting rights granted!");
      } catch (error) {
      console.error("Error granting voting rights: ", error);
      alert("There was an error while granting voting rights.");
      }
      }
	  
	  async function updateRemainingTime() {
		try {
        const remainingTimeInSeconds = await ballotContract.methods.remainingTime().call();
        
        // Calculate hours, minutes, and seconds
        const hours = Math.floor(remainingTimeInSeconds / 3600);
        const minutes = Math.floor((remainingTimeInSeconds % 3600) / 60);
        const seconds = remainingTimeInSeconds % 60;
        
        // Display the remaining time in the format: "X hours, Y minutes, Z seconds"
        const timeString = `${hours} hours, ${minutes} minutes, ${seconds} seconds`;
        
        document.getElementById("remainingTime").innerText = "Time remaining: " + timeString;
    } catch (error) {
        console.error("Error fetching remaining time: ", error);
        alert("There was an error fetching the remaining time.");
    }
}


      async function vote(proposalIndex) {
	  try {
	  const accounts = await web3.eth.requestAccounts();
	  const account = accounts[0];
	  await ballotContract.methods.vote(proposalIndex).send({ from: account });
	  alert("Vote has been cast!");
	  } catch (error) {
	  console.error("Error casting vote: ", error);
	  alert("There was an error while casting your vote.");
	  }
	  }
	  
	  // Function to delegate the vote
      async function delegateVote() {
        try {
          const accounts = await web3.eth.requestAccounts();
          const account = accounts[0];
          const delegateToAddress = document.getElementById("delegateTo").value;

          if (!web3.utils.isAddress(delegateToAddress)) {
            alert("Please enter a valid Ethereum address.");
            return;
          }

          await ballotContract.methods.delegate(delegateToAddress).send({ from: account });
          alert("Vote delegated to: " + delegateToAddress);
        } catch (error) {
          console.error("Error delegating vote: ", error);
          alert("There was an error while delegating the vote.");
        }
      }
	  
	  // Function to get the winner's name
      async function getWinnerName() {
        try {
          const winner = await ballotContract.methods.winnerName().call(); // Use call() for view function
          alert("The winner is: " + web3.utils.hexToUtf8(winner)); // Convert bytes32 to string
        } catch (error) {
          console.error("Error fetching winner: ", error);
          alert("There was an error while fetching winner.");
        }
      }
    </script>
  </body>
</html>