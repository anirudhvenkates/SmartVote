<html>
  <head>
    <title>SmartVote Ballot</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
    <script src="ballot_abi.js"></script>
    <style>
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        padding: 8px;
        text-align: left;
        border: 1px solid #ddd;
      }
      th {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <h1>Grant Voting Rights</h1>
    <div>
      <!-- Text area for inputting voters' addresses -->
      <textarea id="votersList" placeholder="Enter addresses separated by commas"></textarea><br><br>
      <button onclick="grantVotingRights()">Grant Voting Rights</button>
    </div>
    
    <div>
      <h3>Revoke Voting Rights</h3>
      <!-- Text area for inputting voters' addresses -->
      <textarea id="revokeVotersList" placeholder="Enter addresses separated by commas"></textarea><br><br>
      <button onclick="revokeVotingRights()">Revoke Voting Rights</button>
    </div>
    
    <h1>Declare Winner</h1>
    <div>
      <button onclick="getWinnerName()">Get Winner Name</button>
    </div>
    
    <h1>Voting Time Remaining</h1>
    <div>
      <p id="remainingTime">Click to load remaining time...</p>
      <button onclick="updateRemainingTime()">Check Remaining Time</button>
    </div>
    
    <h1>Voters Information</h1>
    <div>
      <button onclick="getVotersInfo()">Get Voters Info</button>
    </div>
    
    <h2>Voters with Voting Rights</h2>
    <table id="votersWithRights">
      <thead>
        <tr>
          <th>Address</th>
          <th>Status</th>
          <th>Weight</th>
          <th>Delegate Address</th>
        </tr>
      </thead>
      <tbody>
        <!-- Voters with Voting Rights will be inserted here -->
      </tbody>
    </table>

    <h2>Voters with Revoked Rights</h2>
    <table id="votersWithRevokedRights">
      <thead>
        <tr>
          <th>Address</th>
        </tr>
      </thead>
      <tbody>
        <!-- Voters with Revoked Rights will be inserted here -->
      </tbody>
    </table>

    <script>
      const web3 = new Web3(Web3.givenProvider || "http://localhost:7545"); // Connect to Ganache

      const contractAddress = "0xc642f89f040BAf0ca423A627423d312723A40020"; // Replace with your deployed contract address
      const ballotContract = new web3.eth.Contract(ballotABI, contractAddress);
      
      // Function to grant voting rights (called by chairperson)
      async function grantVotingRights() {
        try {
          const accounts = await web3.eth.requestAccounts();
          const connectedAddress = accounts[0];  // Get the connected account
          
          // Check if the connected account is the chairperson
          const chairpersonAddress = await ballotContract.methods.chairperson().call();

          if (connectedAddress !== chairpersonAddress) {
            alert("Only the chairperson can grant voting rights.");
            return;
          }

          // Get voter addresses from the textarea input field
          const voterAddresses = document.getElementById('votersList').value.split(',').map(address => address.trim());

          if (voterAddresses.length === 0 || voterAddresses.some(address => !web3.utils.isAddress(address))) {
            alert("Please enter valid Ethereum addresses separated by commas.");
            return;
          }

          await ballotContract.methods.giveRightsToMultipleVoters(voterAddresses).send({ from: chairpersonAddress });
          alert("Voting rights granted!");
        } catch (error) {
          console.error("Error granting voting rights: ", error);
          alert("There was an error while granting voting rights.");
        }
      }
      
      async function revokeVotingRights() {
        try {
          const accounts = await web3.eth.requestAccounts();
          const connectedAddress = accounts[0];  // Get the connected account
          
          // Check if the connected account is the chairperson
          const chairpersonAddress = await ballotContract.methods.chairperson().call();

          if (connectedAddress !== chairpersonAddress) {
            alert("Only the chairperson can revoke voting rights.");
            return;
          }

          // Get voter addresses from the textarea input field
          const votersAddresses = document.getElementById('revokeVotersList').value.split(',').map(address => address.trim());

          if (votersAddresses.length === 0 || votersAddresses.some(address => !web3.utils.isAddress(address))) {
            alert("Please enter valid Ethereum addresses separated by commas.");
            return;
          }

          await ballotContract.methods.revokeVotingRights(votersAddresses).send({ from: chairpersonAddress });
          alert("Voting rights revoked!");
        } catch (error) {
          console.error("Error revoking voting rights: ", error);
          alert("There was an error while revoking voting rights.");
        }
      }
      
      async function getVotersInfo() {
        try {
          const votersInfo = await ballotContract.methods.getVotersInfo().call();

          // Clear previous tables
          document.getElementById("votersWithRights").getElementsByTagName('tbody')[0].innerHTML = '';
          document.getElementById("votersWithRevokedRights").getElementsByTagName('tbody')[0].innerHTML = '';

          // Categorize voters into two groups
          votersInfo.forEach(info => {
            // Split the information by commas to parse it
            const voterInfo = info.split(", ");
            const address = voterInfo[0].replace("Address: ", "").trim();
            const status = voterInfo[1].replace("Status: ", "").trim();
            const weight = voterInfo[2].replace("Weight: ", "").trim();
            const delegate = voterInfo[3].replace("Delegate: ", "").trim();

            // Check weight to categorize the voters
            if (weight === "Voting Rights") {
              // Voter with voting rights (weight > 0)
              const row = `<tr>
                            <td>${address}</td>
                            <td>${status}</td>
                            <td>${weight}</td>
                            <td>${delegate}</td>
                          </tr>`;
              document.getElementById("votersWithRights").getElementsByTagName('tbody')[0].innerHTML += row;
            } else {
              // Voter with revoked rights (weight = 0)
              const row = `<tr>
                            <td>${address}</td>
                          </tr>`;
              document.getElementById("votersWithRevokedRights").getElementsByTagName('tbody')[0].innerHTML += row;
            }
          });
        } catch (error) {
          console.error("Error fetching voters info: ", error);
          alert("There was an error fetching the voters' information.");
        }
      }
      
      async function updateRemainingTime() {
        try {
          const remainingTimeInSeconds = await ballotContract.methods.remainingTime().call();
          
          // Calculate hours, minutes, and seconds
          const hours = Math.floor(remainingTimeInSeconds / 3600);
          const minutes = Math.floor((remainingTimeInSeconds % 3600) / 60);
          const seconds = remainingTimeInSeconds % 60;
          
          // Display the remaining time in the format: "X hours, Y minutes, Z seconds"
          const timeString = `${hours} hours, ${minutes} minutes, ${seconds} seconds`;
          
          document.getElementById("remainingTime").innerText = "Time remaining: " + timeString;
        } catch (error) {
          console.error("Error fetching remaining time: ", error);
          alert("There was an error fetching the remaining time.");
        }
      }

      // Function to get the winner's name
      async function getWinnerName() {
        try {
          const accounts = await web3.eth.requestAccounts();
          const connectedAddress = accounts[0];  // Get the connected account
          
          // Check if the connected account is the chairperson
          const chairpersonAddress = await ballotContract.methods.chairperson().call();

          if (connectedAddress !== chairpersonAddress) {
            alert("Only the chairperson can get the winner name.");
            return;
          }

          const winner = await ballotContract.methods.winnerName().call(); // Use call() for view function
          alert("The winner is: " + web3.utils.hexToUtf8(winner)); // Convert bytes32 to string
        } catch (error) {
          console.error("Error fetching winner: ", error);
          alert("There was an error while fetching the winner.");
        }
      }
    </script>
  </body>
</html>